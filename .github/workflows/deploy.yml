name: ğŸš€ Build, Test & Deploy Spring Boot to Render

on:
  push:
    branches: [main]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©ration du code
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4

      # Ã‰tape 2 : Setup Java (point clÃ© DevOps)
      - name: â˜• Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Ã‰tape 3 : Build + Tests (Ã©lÃ©ment clÃ© Ã  montrer)
      - name: ğŸ› ï¸ Build and Test with Maven
        run: mvn clean package # Retirez "-DskipTests" pour la dÃ©mo !

      # Ã‰tape 4 : Construction de l'image Docker
      - name: ğŸ³ Build Docker Image
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/springboot-app:${{ github.sha }}
        run: |
          docker build -t $DOCKER_IMAGE .

      # Ã‰tape 5 : Push sur DockerHub (montrer la centralisation des artefacts)
      - name: â¬†ï¸ Push Docker Image
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/springboot-app:${{ github.sha }}
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker push $DOCKER_IMAGE

      # Ã‰tape 6 : DÃ©ploiement sur Render (via webhook)
      - name: ğŸš€ Deploy to Render
        run: |
          echo "âœ… DÃ©clenchement du dÃ©ploiement sur Render..."
          curl -X POST -o render-deploy.log ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          echo "ğŸ“ Logs de dÃ©ploiement :"
          cat render-deploy.log